import { Callout } from "nextra/components";

# 個人用 Misskey サーバを構築する

一番安いのを頼む

## Overview

個人で遊ぶ用の [Misskey](https://github.com/misskey-dev/misskey) サーバ（v2023.10.0）を Vultr と Cloudflare で構築する

## Architecture

- VPS

  [Vultr](https://www.vultr.com/) で一番安そうな VPS を借りた<br/>
  インストール/アップデート時以外の負荷はそこまで掛からないらしい

  | Column      | Value               |
  | ----------- | ------------------- |
  | Server      | Vultr Cloud Compute |
  | Location    | Tokyo               |
  | OS          | Ubuntu 22.04        |
  | Application | NodeJS              |
  | Storage     | 25 GB NVMe          |
  | vCPU/s      | 1 vCPU              |
  | RAM         | 1024.00 MB          |
  | Additonal   | Enable IPv6         |

- Domain / DNS

  [Cloudflare Registrar](https://www.cloudflare.com/ja-jp/products/registrar/) でドメインを取得、管理

- Object Storage

  [Cloudflare R2](https://www.cloudflare.com/ja-jp/developer-platform/r2/) を利用

## Flow

ドメインの購入から Misskey の起動までの一連の流れ

### Cloudflare で Domain の取得

Cloudflare で好みのドメインを購入する

[Cloudflare](https://www.cloudflare.com/) にサインアップ、ログインした後、[ダッシュボード](https://dash.cloudflare.com/)が確認できるようになる<br/>
左のサイドバーから ドメイン登録 > ドメインの登録 を開く

![registerDomain1](/others/registerDomain1.png)

好みのドメイン名で検索すれば、利用可能な類似のドメイン名が一覧で表示される<br/>
利用ができないドメイン名であれば、その旨も表示されるので再考する

![registerDomain2](/others/registerDomain2.png)

利用したいドメイン名を選択できたら、購入を完了する

---

### Vultr で VPS を構築する

Vultr サーバの環境構築については以下の記事を参考のこと<br/>
この記事の **VPS サーバを借りて、環境を整備する** の項に従って実行すれば、このステップは完了<br/>
筆者の VPS の構築については、上述の [Architecture](#architecture) に記載

[Misskey のサーバを設置する（v11 系） - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)

<Callout type="info" emoji="️ℹ️">
  DNS の設定に必要となるため、作成した VPS の `IP Address` と `IPv6 Address`
  を確認しておく
</Callout>

---

### Cloudflare で DNS の設定

Cloudflare の[ダッシュボード](https://dash.cloudflare.com/)にて、左のサイドバーから ドメイン登録 > ドメインの管理 を開く

先程購入したドメインが追加されているので、該当ドメインの **管理** を選択

![dnsSetting1](/others/dnsSetting1.png)

クイックアクションの **DNS の設定を更新する** を選択

DNS レコードの管理画面が表示されるので、**レコードの追加** を選択し、以下の内容で保存する<br/>

<Callout type="info" emoji="️ℹ️">
  名前には利用したいサブドメインを設定する<br />
  ドメインが`example.com`だった場合、サブドメインを`mk`とすると、`mk.example.com`がサーバーのURLとなる<br />
  サブドメインを付与したくない場合は、`@`を入力する
</Callout>

| タイプ | 名前           | アドレス                |
| ------ | -------------- | ----------------------- |
| A      | (サブドメイン) | (Vultr の IP Address)   |
| AAAA   | (サブドメイン) | (Vultr の IPv6 Address) |

![dnsSetting2](/others/dnsSetting2.png)

---

### Vultr サーバ への SSH の設定

WIP

[Misskey のサーバを設置する（v11 系） - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)

---

### [Misskey install shell script v3.0.0](https://misskey-hub.net/docs/install/bash.html) の実行

手動でやってみたりしようともしたけど、多分これが一番楽で早いと思います

手順に書いてあるとおりに進める<br/>
新しいもの好きなので develop branch を選んだが、普通は master branch にするのが無難だと思う

途中で Cloudflare の API Key を要求されるが、きちんと誘導してくれるのでそれに従えば問題ない<br/>
書かれている通り [Cloudflare のダッシュボード](https://dash.cloudflare.com/profile/api-tokens) を開いて `Global API Key` を表示、コピペすればよい

![checkCloudflareApiKey](/others/checkCloudflareApiKey.png)

<Callout type="error" emoji="️🚫">
  途中で処理に失敗し、再度スクリプトを実行する場合は以下に注意する
  > RedisやPostgresのインストールが終わっている場合、「`install locally`」は`No`にしてください。
</Callout>

以下、筆者の選択一覧　大体デフォルト

| Install script option                                         | Value                                                  |
| ------------------------------------------------------------- | ------------------------------------------------------ |
| Do you use systemd to run Misskey?                            | Y (Use `Systemd`)                                      |
| Repository url where you want to install                      | `https://github.com/misskey-dev/misskey.git` (default) |
| The name of a new directory to clone                          | misskey (default)                                      |
| Branch or Tag                                                 | **develop**                                            |
| Enter the name of user with which you want to execute Misskey | misskey (default)                                      |
| Enter host where you want to install Misskey                  | (Own Host Name, e.g. `example.com`)                    |
| Do you want to setup nginx?                                   | Y                                                      |
| Misskey port                                                  | 3000 (default)                                         |
| Do you want it to open ports, to setup ufw or iptables?       | u (To setup ufw)                                       |
| SSH port                                                      | 22 (default)                                           |
| Do you want it to setup certbot to connect with https?        | Y                                                      |
| Do you use Cloudflare?                                        | Y                                                      |
| Enter Email address you registered to Cloudflare              | (Own Email Address)                                    |
| Cloudflare API Key                                            | (Own Cloudflare API Key)                               |
| Tell me which port Misskey will watch                         | 3000 (default)                                         |
| Do you want to install postgres locally?                      | Y                                                      |
| Database user name                                            | misskey (default)                                      |
| Database user password                                        | (Any password)                                         |
| Database name                                                 | mk1 (default)                                          |
| Do you want to install redis locally?                         | Y                                                      |
| Redis password                                                | (Any password)                                         |

---

### Cloudflare R2 でオブジェクトストレージの設定

WIP

[misskey のオブジェクトストレージに cloudflare r2 を利用する - Qiita](https://qiita.com/hihumikan/items/1f692f3bd5516820e0ec)

---

### Cloudflare R2 でバックアップの設定

WIP

[misskey データベースのバックアップを cron で定期的に Cloudflare R2 に保存する | 小束弓月](https://note.com/yu_koduka/n/n0ba5807b16bf)

---

### ノート検索の許可

（おそらく）デフォルトだとノート検索は無効になっている（負荷対策？）<br/>
コントロールパネル > 管理 > ロール > ベースロール 内の **ノート検索の利用** を **はい** に変更する

![changeSearchPermission](/others/changeSearchPermission.png)

---

### (Meilisearch の設定)

WIP

[meilisearch not working · Issue #11998 · misskey-dev/misskey](https://github.com/misskey-dev/misskey/issues/11998)

## Bonus

カスタム絵文字 ライセンス情報

[MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/) 用

```txt
Public Domain.
Generated by [MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/).
[MEGAMOJI Licence](https://github.com/zk-phi/MEGAMOJI/blob/master/LICENSE.markdown).
```

[絵文字ジェネレータ](https://emoji-gen.ninja/)用

```txt
Public Domain.
Generated by [Emoji Generator](https://emoji-gen.ninja/)
```

[ファイナルファンタジー XIV ファンキット](https://jp.finalfantasyxiv.com/lodestone/special/fankit/)用

```txt
(C) SQUARE ENIX CO., LTD. All Rights Reserved.
[ファイナルファンタジーXIV 著作物利用許諾条件](http://support.jp.square-enix.com/rule.php?id=5381&la=0&tag=authc&_ebx=t87tbevhtu.1689168164.7smav6v)
```

## Ref

偉大なる開発者たちと先駆者たちに深く感謝

- [Misskey 構築の手引き | Misskey Hub](https://misskey-hub.net/docs/install/manual.html)
- [Misskey install shell script v3.0.0 | Misskey Hub](https://misskey-hub.net/docs/install/bash.html)
- [Misskey のサーバを設置する（v11 系） - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)
- [Misskey のおひとり様インスタンスを建てる](https://zenn.dev/see2et/articles/building-an-one-person-instance-of-misskey#ssh%E6%8E%A5%E7%B6%9A%E3%81%A8%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89)
- [misskey のオブジェクトストレージに cloudflare r2 を利用する - Qiita](https://qiita.com/hihumikan/items/1f692f3bd5516820e0ec)
- [Misskey インスタンスで最初に設定するべきインスタンス設定とその他設定の説明 | aqz/tamaina](https://hide.ac/articles/Y504SIabp)
- [misskey データベースのバックアップを cron で定期的に Cloudflare R2 に保存する | 小束弓月](https://note.com/yu_koduka/n/n0ba5807b16bf)
- [Amazon S3 と API の互換性がある Cloudflare R2 を AWS CLI から使ってみる | DevelopersIO](https://dev.classmethod.jp/articles/using-cloudflare-r2-compatible-with-amazon-s3-api-from-aws-cli/)
- [Misskey で Cloudflare R2 Storage を使う](https://nanasi-apps.xyz/r2-misskey)
- [Misskey で Meilisearch を導入するやり方](https://nanasi-apps.xyz/misskey-meilisearch)
- [Windows デスクトップ環境で UUID(GUID)を生成する方法 - torutk のブログ](https://torutk.hatenablog.jp/entry/20160519/p1)
- [Meilisearch Documentation](https://www.meilisearch.com/docs/learn/security/master_api_keys#using-default-api-keys-for-authorization)
- [Docker Compose 版 Misskey にノート検索 (Meilisearch) を導入する - Qiita](https://qiita.com/arkw/items/81238fe96ec602a2e055)
