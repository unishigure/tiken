import { Callout } from "nextra/components";

# å€‹äººç”¨ Misskey ã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹

ä¸€ç•ªå®‰ã„ã®ã‚’é ¼ã‚€

## Overview

å€‹äººã§éŠã¶ç”¨ã® [Misskey](https://github.com/misskey-dev/misskey) ã‚µãƒ¼ãƒï¼ˆv2023.10.0ï¼‰ã‚’ Vultr ã¨ Cloudflare ã§æ§‹ç¯‰ã™ã‚‹

## Architecture

- VPS

  [Vultr](https://www.vultr.com/) ã§ä¸€ç•ªå®‰ãã†ãª VPS ã‚’å€Ÿã‚ŠãŸ<br/>
  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ä»¥å¤–ã®è² è·ã¯ãã“ã¾ã§æ›ã‹ã‚‰ãªã„ã‚‰ã—ã„

  | Column      | Value               |
  | ----------- | ------------------- |
  | Server      | Vultr Cloud Compute |
  | Location    | Tokyo               |
  | OS          | Ubuntu 22.04        |
  | Application | NodeJS              |
  | Storage     | 25 GB NVMe          |
  | vCPU/s      | 1 vCPU              |
  | RAM         | 1024.00 MB          |
  | Additonal   | Enable IPv6         |

  [Vultræ‹›å¾…ãƒªãƒ³ã‚¯](https://www.vultr.com/?ref=9550402-8H)<br/>
  ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã™ã‚‹ã¨ã€$100åˆ†ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒè²°ãˆã¾ã™ï¼ˆæœ‰åŠ¹æœŸé™14æ—¥ï¼‰

- Domain / DNS

  [Cloudflare Registrar](https://www.cloudflare.com/ja-jp/products/registrar/) ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ã€ç®¡ç†

- Object Storage

  [Cloudflare R2](https://www.cloudflare.com/ja-jp/developer-platform/r2/) ã‚’åˆ©ç”¨

## Flow

ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è³¼å…¥ã‹ã‚‰ Misskey ã®èµ·å‹•ã¾ã§ã®ä¸€é€£ã®æµã‚Œ<br/>
ãƒãƒ¼ãƒˆã®å¤‰æ›´ãªã©ã¯ç‰¹ã«ã—ã¦ã„ãªã„ã®ã§ã€ã“ã ã‚ã‚Šã‚„äº‹æƒ…ãŒã‚ã‚‹å ´åˆã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„

### Cloudflare ã§ Domain ã®å–å¾—

Cloudflare ã§å¥½ã¿ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è³¼å…¥ã™ã‚‹

[Cloudflare](https://www.cloudflare.com/) ã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå¾Œã€[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/)ãŒç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚‹<br/>
å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ² > ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ² ã‚’é–‹ã

![registerDomain1](/others/build-misskey-in-vultr/registerDomain1.png)

å¥½ã¿ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã§æ¤œç´¢ã™ã‚Œã°ã€åˆ©ç”¨å¯èƒ½ãªé¡ä¼¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒä¸€è¦§ã§è¡¨ç¤ºã•ã‚Œã‚‹<br/>
åˆ©ç”¨ãŒã§ããªã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã§ã‚ã‚Œã°ã€ãã®æ—¨ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§å†è€ƒã™ã‚‹

![registerDomain2](/others/build-misskey-in-vultr/registerDomain2.png)

åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’é¸æŠã§ããŸã‚‰ã€è³¼å…¥ã‚’å®Œäº†ã™ã‚‹

---

### Vultr ã§ VPS ã‚’æ§‹ç¯‰ã™ã‚‹

[Vultr](https://www.vultr.com/)ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€æ–°è¦ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã™ã‚‹

Choose Server ã§ `Cloud Compute` ã‚’é¸æŠ

![choiceVultrVps1](/others/build-misskey-in-vultr/choiceVultrVps1.png)

CPU & Storage Technology ã§å¥½ããªã‚‚ã®ã‚’é¸ã¶<br/>
å·¦2ã¤ãŒãŠãã‚‰ãç„¡é›£ã€€ä¸€ç•ªå³ã¯ã¡ã‚‡ã£ã¨å®‰ã„ãŒæ€§èƒ½ãŒä½ã„

![choiceVultrVps2](/others/build-misskey-in-vultr/choiceVultrVps2.png)

Server Location ã§è¿‘æ‰€ã‚’é¸ã¶

![choiceVultrVps3](/others/build-misskey-in-vultr/choiceVultrVps3.png)

Server Image ã® Operatins System ã§ `Ubuntu` ã® LTS ã‚’é¸æŠ

![choiceVultrVps4](/others/build-misskey-in-vultr/choiceVultrVps4.png)

Server Image ã® Marketplace Apps ã§ `NodeJS` ã‚’é¸æŠ

![choiceVultrVps5](/others/build-misskey-in-vultr/choiceVultrVps5.png)

Server Size ã§å¥½ã¿ã®ã‚µã‚¤ã‚ºã‚’é¸æŠ<br/>
~~å¾Œã‹ã‚‰å¤‰æ›´ã¯å‡ºæ¥ãªã„ãŸã‚æ³¨æ„~~ Settings > Change Plan ã§å‡ºæ¥ãŸ<br/>
ç¾åœ¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å‡ºæ¥ã‚‹ãŒã€ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å‡ºæ¥ãªã„ã‚‰ã—ã„

![choiceVultrVps6](/others/build-misskey-in-vultr/choiceVultrVps6.png)

Add Auto Backups ã‚‚ãŠå¥½ã¿ã§<br/>

![choiceVultrVps7](/others/build-misskey-in-vultr/choiceVultrVps7.png)

Additional Features ã§ `Enable IPv6` ã‚’é¸æŠ

![choiceVultrVps8](/others/build-misskey-in-vultr/choiceVultrVps8.png)

Server Hostname & Label ã§ä»»æ„ã®åå‰ã‚’å…¥åŠ›

![choiceVultrVps9](/others/build-misskey-in-vultr/choiceVultrVps9.png)

Deploy ã‚’é–‹å§‹

![choiceVultrVps10](/others/build-misskey-in-vultr/choiceVultrVps10.png)

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚äº†ã—ãŸã‚‰ã€VPS ã®æ§‹ç¯‰ã¯å®Œäº†

<Callout type="info" emoji="ï¸â„¹ï¸">
  DNS ã®è¨­å®šã®ãŸã‚ã€`IP Address` ã¨ `IPv6 Address` ã‚’ç¢ºèªã—ã¦ãŠã<br/>
  SSH ã®è¨­å®šã®ãŸã‚ã€root ãƒ¦ãƒ¼ã‚¶ã® `Password` ã‚’ç¢ºèªã—ã¦ãŠã
  ![checkVpsInfo](/others/build-misskey-in-vultr/checkVpsInfo.png)
</Callout>

---

### Cloudflare ã§ DNS ã®è¨­å®š

Cloudflare ã®[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/)ã«ã¦ã€å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ² > ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç®¡ç† ã‚’é–‹ã

å…ˆç¨‹è³¼å…¥ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©²å½“ãƒ‰ãƒ¡ã‚¤ãƒ³ã® **ç®¡ç†** ã‚’é¸æŠ

![dnsSetting1](/others/build-misskey-in-vultr/dnsSetting1.png)

ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã® **DNS ã®è¨­å®šã‚’æ›´æ–°ã™ã‚‹** ã‚’é¸æŠ

DNS ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€**ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ ** ã‚’é¸æŠã—ã€ä»¥ä¸‹ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹<br/>

<Callout type="info" emoji="ï¸â„¹ï¸">
  åå‰ã«ã¯åˆ©ç”¨ã—ãŸã„ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹<br />
  ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ`example.com`ã ã£ãŸå ´åˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’`mk`ã¨ã™ã‚‹ã¨ã€`mk.example.com`ãŒã‚µãƒ¼ãƒãƒ¼ã®URLã¨ãªã‚‹<br />
  ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä»˜ä¸ã—ãŸããªã„å ´åˆã¯ã€`@`ã‚’å…¥åŠ›ã™ã‚‹
</Callout>

| ã‚¿ã‚¤ãƒ— | åå‰           | ã‚¢ãƒ‰ãƒ¬ã‚¹                      |
| ------ | -------------- | ----------------------------- |
| A      | (ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³) | (VPS ã® IP Address) |
| AAAA   | (ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³) | (VPS ã® IPv6 Address)    |

![dnsSetting2](/others/build-misskey-in-vultr/dnsSetting2.png)

---

### SSH æ¥ç¶šã®è¨­å®š

1. SSH Key ã®ç”Ÿæˆ

   SSH Key ã‚’ç”Ÿæˆã—ã¦ãŠã<br/>
   ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ˆã„<br/>
   ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã¯ç©ºã§ã‚‚ç”Ÿæˆã§ãã‚‹ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é¢ã§è¨­å®šã—ã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„

   ```bash
   ssh-keygen -t ed25519
   ```

   ä½œæˆå¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿å­˜å…ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ç¢ºèªã—ã¦ãŠã

   ```bash
   Your identification has been saved in C:/Users/USERNAME/.ssh/id_ed25519
   Your public key has been saved in C:/Users/USERNAME/.ssh/id_ed25519.pub
   ```

2. `.ssh/config` ã®è¨˜è¿°

   VPS ã¸ã®æ¥ç¶šæƒ…å ±ã‚’ `.ssh/config` ã«è¨˜è¿°ã™ã‚‹ (SSH Key ã®ä¿å­˜å…ˆã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹)

   `config` ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯ãã‚Œã«è¿½è¨˜ã™ã‚‹<br/>
   ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã§æ–°è¦ã«ä½œæˆã™ã‚‹

   ```text filename=".ssh/config"
   Host misskey                          # ä»»æ„ã®æ¥ç¶šå…ˆå
         User {{YourUserName}}           # ã“ã®å¾Œ VPS ä¸Šã«ä½œæˆã™ã‚‹ä½œæ¥­ç”¨ãƒ¦ãƒ¼ã‚¶
         Hostname xx.xx.xx.xx            # VPS ã® IP Address
         IdentityFile ~/.ssh/id_ed25519  # ä¸Šè¨˜ã§ä½œæˆã—ãŸ SSH Key ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
   ```

3. SSH ã§ VPS ã«æ¥ç¶š

   ã¾ãš root ãƒ¦ãƒ¼ã‚¶ã§ VPS ã‚µãƒ¼ãƒã«æ¥ç¶šã™ã‚‹<br/>
   åˆå›æ¥ç¶šæ™‚ã®ã¿æ¥ç¶šã‚’ç¶šã‘ã‚‹ã‹ç¢ºèªã•ã‚Œã‚‹ãŸã‚ã€`yes`ã‚’å…¥åŠ›ã™ã‚‹<br/>
   root ãƒ¦ãƒ¼ã‚¶ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦æ±‚ã•ã‚Œã‚‹ãŸã‚ã€Vultr ã§ç¢ºèªã—ãŸ Password ã‚’å…¥åŠ›ã™ã‚‹

   ```bash
   ssh root@misskey
   ```

4. ä½œæ¥­ç”¨ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹

   æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹

   ```bash
   adduser {{YourUserName}}
   ```

   ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã« sudo å®Ÿè¡Œã‚’è¨±å¯ã™ã‚‹

   ```bash
   usermod -aG sudo {{YourUserName}}
   ```

5. VPS ã« SSH Key ã‚’ä¿å­˜ã™ã‚‹

   ä½œæ¥­ç”¨ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆã¦ã€SSH Key ã®ä¿å­˜å…ˆã‚’ä½œæˆã™ã‚‹

   ```bash
   sudo -iu {{YourUserName}}
   mkdir .ssh
   chmod 700 .ssh
   cd .ssh
   touch authorized_keys
   chmod 600 authorized_keys
   nano authorized_keys
   ```

   nano ã‚¨ãƒ‡ã‚£ã‚¿ãŒé–‹ãã®ã§ã€1. ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ç”Ÿæˆã—ãŸ `id_ed25519.pub` ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è»¢è¨˜ã™ã‚‹<br/>
   `Ctrl+S` ã§ä¿å­˜ã—ã€`Ctrl+X` ã§ã‚¨ãƒ‡ã‚£ã‚¿ã‚’çµ‚äº†ã™ã‚‹

6. sshd ã®è¨­å®š

   `sshd_config` ã‚’é–‹ã

   ```bash
   sudo nano /etc/ssh/sshd_config
   ```

   ä»¥ä¸‹ã®é …ç›®ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ(`#`)ã‚’å‰Šé™¤ã—ã€è¨­å®šã‚’å¤‰æ›´ã™ã‚‹

   - `PermitRootLogin no` : ãƒ«ãƒ¼ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç¦æ­¢ã™ã‚‹
   - `PasswordAuthentication no` : ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç¦æ­¢ã™ã‚‹

   sshd ã®è¨­å®šã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

   ```bash
   sudo sshd -t
   ```

   å•é¡ŒãŒãªã‘ã‚Œã°ã€sshd ã‚’å†èµ·å‹•ã™ã‚‹

   ```bash
   sudo systemctl restart sshd
   ```

7. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®š

   SSH æ¥ç¶šã ã‘ã‚’è¨±å¯ã™ã‚‹

   ```bash
   sudo ufw allow 22/tcp
   sudo ufw enable
   ```

8. æ¥ç¶šç¢ºèª

   ã“ã“ã¾ã§ã®è¨­å®šã§ã€æ„å›³é€šã‚Š SSH æ¥ç¶šãŒã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

   æ–°ã—ãã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ¥ç¶šã™ã‚‹<br/>
   ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¨­å®šã—ãŸå ´åˆã¯ã€å…¥åŠ›ã™ã‚‹

   ```bash
   ssh misskey
   ```

   ä½œæˆã—ãŸä½œæ¥­ç”¨ãƒ¦ãƒ¼ã‚¶ã§æ¥ç¶šãŒå‡ºæ¥ã¦ã„ã‚Œã°ã€SSH ã®è¨­å®šã¯å®Œäº†

---

### [Misskey install shell script v3.0.0](https://misskey-hub.net/docs/install/bash.html) ã®å®Ÿè¡Œ

æ‰‹å‹•ã§ã‚„ã£ã¦ã¿ãŸã‚Šã—ã‚ˆã†ã¨ã‚‚ã—ãŸã‘ã©ã€å¤šåˆ†ã“ã‚ŒãŒä¸€ç•ªæ¥½ã§æ—©ã„ã¨æ€ã„ã¾ã™

æ‰‹é †ã«æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚Šã«é€²ã‚ã‚‹<br/>
æ–°ã—ã„ã‚‚ã®å¥½ããªã®ã§ develop branch ã‚’é¸ã‚“ã ãŒã€æ™®é€šã¯ master branch ã«ã™ã‚‹ã®ãŒç„¡é›£ã ã¨æ€ã†

é€”ä¸­ã§ Cloudflare ã® API Key ã‚’è¦æ±‚ã•ã‚Œã‚‹ãŒã€ãã¡ã‚“ã¨èª˜å°ã—ã¦ãã‚Œã‚‹ã®ã§ãã‚Œã«å¾“ãˆã°å•é¡Œãªã„<br/>
æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Š [Cloudflare ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/profile/api-tokens) ã‚’é–‹ã„ã¦ `Global API Key` ã‚’è¡¨ç¤ºã€ã‚³ãƒ”ãƒšã™ã‚Œã°ã‚ˆã„

![checkCloudflareApiKey](/others/build-misskey-in-vultr/checkCloudflareApiKey.png)

<Callout type="error" emoji="ï¸ğŸš«">
  é€”ä¸­ã§å‡¦ç†ã«å¤±æ•—ã—ã€å†åº¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã«æ³¨æ„ã™ã‚‹
  > Redisã‚„Postgresã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã€ã€Œ`install locally`ã€ã¯`No`ã«ã—ã¦ãã ã•ã„ã€‚
</Callout>

ä»¥ä¸‹ã€ç­†è€…ã®é¸æŠä¸€è¦§ã€€å¤§ä½“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

| Install script option                                         | Value                                                  |
| ------------------------------------------------------------- | ------------------------------------------------------ |
| Do you use systemd to run Misskey?                            | Y (Use `Systemd`)                                      |
| Repository url where you want to install                      | `https://github.com/misskey-dev/misskey.git` (default) |
| The name of a new directory to clone                          | misskey (default)                                      |
| Branch or Tag                                                 | **develop**                                            |
| Enter the name of user with which you want to execute Misskey | misskey (default)                                      |
| Enter host where you want to install Misskey                  | (Own Host Name, e.g. `example.com`)                    |
| Do you want to setup nginx?                                   | Y                                                      |
| Misskey port                                                  | 3000 (default)                                         |
| Do you want it to open ports, to setup ufw or iptables?       | u (To setup ufw)                                       |
| SSH port                                                      | 22 (default)                                           |
| Do you want it to setup certbot to connect with https?        | Y                                                      |
| Do you use Cloudflare?                                        | Y                                                      |
| Enter Email address you registered to Cloudflare              | (Own Email Address)                                    |
| Cloudflare API Key                                            | (Own Cloudflare API Key)                               |
| Tell me which port Misskey will watch                         | 3000 (default)                                         |
| Do you want to install postgres locally?                      | Y                                                      |
| Database user name                                            | misskey (default)                                      |
| Database user password                                        | (Any password)                                         |
| Database name                                                 | mk1 (default)                                          |
| Do you want to install redis locally?                         | Y                                                      |
| Redis password                                                | (Any password)                                         |

---

### Cloudflare R2 ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š

Cloudflare ã®[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/)ã‚’é–‹ã<br/>
å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ R2 > æ¦‚è¦ ã‚’é–‹ãã€**ãƒã‚±ãƒƒãƒˆã®ä½œæˆ**ã‚’é¸æŠ

![createBucket1](/others/build-misskey-in-vultr/createBucket1.png)

ä»»æ„ã®ãƒã‚±ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ä½œæˆã™ã‚‹

![createBucket2](/others/build-misskey-in-vultr/createBucket2.png)

ãƒã‚±ãƒƒãƒˆã®è©³ç´°ç”»é¢ã‚’é–‹ãã€S3 API ã‚’ç¢ºèªã™ã‚‹

![createBucket3](/others/build-misskey-in-vultr/createBucket3.png)

r2.dev ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹<br/>
ã¾ãŸã€**ãƒ‘ãƒ–ãƒªãƒƒã‚¯ r2.dev ãƒã‚±ãƒƒãƒˆ URL** ã‚’ç¢ºèªã—ã¦ãŠã

![createBucket4](/others/build-misskey-in-vultr/createBucket4.png)

å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ R2 > æ¦‚è¦ ã«æˆ»ã‚Šã€**R2 API ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†** ã‚’é¸æŠã™ã‚‹

![createR2token1](/others/build-misskey-in-vultr/createR2token1.png)

API ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ç”»é¢ã§ã€**API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹** ã‚’é¸æŠ

API ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆç”»é¢ã§ã€ä»»æ„ã®ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›ã™ã‚‹<br/>
ã¾ãŸã€æ¨©é™ã§ **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿** ã‚’é¸æŠã™ã‚‹

![createR2token2](/others/build-misskey-in-vultr/createR2token2.png)

ä½œæˆã•ã‚ŒãŸ API ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹<br/>
S3 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã® **ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼ ID** ã¨ **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼** ã‚’ç¢ºèªã™ã‚‹

<Callout type="error" emoji="ï¸ğŸš«">
  ã“ã®ç”»é¢ã¯ä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ã®ã§æ³¨æ„
</Callout>

![createR2token3](/others/build-misskey-in-vultr/createR2token3.png)

Misskey ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‹ã‚‰ è¨­å®š > ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã‚’é–‹ã
ä»¥ä¸‹ã®é …ç›®ã‚’è¨­å®š

| Column     | Value                                        |
| ---------- | -------------------------------------------- |
| Base URL   | ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ r2.dev ãƒã‚±ãƒƒãƒˆ URLï¼‰           |
| Bucket     | ï¼ˆä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆåï¼‰                       |
| Prefix     | ï¼ˆä»»æ„ã® Prefixï¼‰                            |
| Endpoint   | ï¼ˆS3 API ã® FQDNï¼‰                           |
| Region     | us-east-1                                    |
| Access Key | ï¼ˆAPI ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼ IDï¼‰           |
| Secret Key | ï¼ˆAPI ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼ï¼‰ |

**Proxy ã‚’åˆ©ç”¨ã™ã‚‹** ã‚’ **ç„¡åŠ¹** ã«ã€
**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«'public-read'ã‚’è¨­å®šã™ã‚‹** ã‚’ **æœ‰åŠ¹** ã«ã™ã‚‹

![settingObjectstorage](/others/build-misskey-in-vultr/settingObjectstorage.png)

Misskey ã®ãƒ‰ãƒ©ã‚¤ãƒ–ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ç”»åƒãŒãƒœã‚±ã¦ã„ãªã‘ã‚Œã°è¨­å®šã¯å®Œäº†

---

### Cloudflare R2 ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã® R2 ã®ç”¨æ„

   [Misskey ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸](#cloudflare-r2-ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š)ã¨åŒæ§˜ã«ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹

   ä»»æ„ã®ãƒã‚±ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ä½œæˆã™ã‚‹\
   ãƒã‚±ãƒƒãƒˆã®è©³ç´°ç”»é¢ã‚’é–‹ãã€**S3 API** ã‚’ç¢ºèªã™ã‚‹

   æ›´ã«ã€è¨­å®šä¸‹éƒ¨ã® ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« ãƒ«ãƒ¼ãƒ« ã‚’è¨­å®šã™ã‚‹\
   ä»»æ„ã®å®šæœŸçš„ãªæœŸé–“ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé †æ¬¡å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†è¨­å®šã—ã¦ãŠã

   ![lifecycleSetting](/others/build-misskey-in-vultr/lifecycleSetting.png)

2. R2 API ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”¨æ„

   [Misskey ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸](#cloudflare-r2-ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š)ã¨åŒæ§˜ã«ã€R2 API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹

   ä»»æ„ã®ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›ã—ã€æ¨©é™ã‚’ **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿** ã¨ã™ã‚‹\
   ä½œæˆã•ã‚ŒãŸ S3 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã® **ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼ ID** ã¨ **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ ã‚­ãƒ¼** ã‚’ç¢ºèªã™ã‚‹

3. aws configure ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

   Misskey ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã€postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆã‚‹

   ```bash
   ssh misskey
   ```

   ```bash
   sudo su - postgres
   ```

   aws configure ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

   ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä»»æ„ã®ã‚‚ã®ã‚’å…¥åŠ›\
   AWS Access Key ID ã¨ AWS Secret Access Key ã«ã¯ 1. ã§ç¢ºèªã—ãŸã‚‚ã®ã‚’ãã‚Œãã‚Œå…¥åŠ›ã™ã‚‹

   ```bash
   aws configure --profile {{AnyProfileName}}
   AWS Access Key ID [None]: {{YourAccessKeyID}}
   AWS Secret Access Key [None]: {{YourSecretAccessKey}}
   Default region name [None]:
   Default output format [None]: json
   ```

4. ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é…ç½®

   å¼•ãç¶šã postgres ãƒ¦ãƒ¼ã‚¶ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é…ç½®ã™ã‚‹

   ```bash
   nano backup-psql-all.sh
   ```

   ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ `backup-psql-all.sh` ã«ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹\
   YourBucketName ã«ã¯ 1. ã§ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆåã‚’å…¥åŠ›\
   YourProfileName ã«ã¯ 3. ã§ä½œæˆã—ãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›\
   YourEndpointName ã«ã¯ 1. ã§ç¢ºèªã—ãŸ S3 API ã‚’å…¥åŠ›ã™ã‚‹ï¼ˆ`.com`ä»¥å‰ã¾ã§ï¼‰

   ![S3 API sample](/others/build-misskey-in-vultr/s3api_sample.png)

   ```bash filename="backup-psql-all.sh"
   #!/bin/bash
   TIME=$(date +%Y%m%d_%H-%M-%S)
   cd /tmp
   pg_dumpall > dumpall_psql.dmp
   tar czf dumpall_psql.tar.gz dumpall_psql.dmp
   chmod 700 dumpall_psql.tar.gz
   aws s3 cp dumpall_psql.tar.gz s3://{{YourBucketName}}/dumpall_psql_$TIME.tar.gz --profile {{YourProfileName}} --endpoint-url {{YourEndpointName}}
   rm dumpall_psql.tar.gz dumpall_psql.dmp
   ```

   ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ¨©é™ã‚’å¤‰æ›´

   ```bash
   chmod 744Â backup-psql-all.sh
   ```

   ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€`dumpall_psql_yyyyMMdd_HH-mm-ss.tar.gz` ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒ R2 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸ

   ```bash
   bash ./backup-psql-all.sh
   ```

5. crontab ã®è¨­å®š

   å¼•ãç¶šã postgres ãƒ¦ãƒ¼ã‚¶ã§ crontab ã‚’ç·¨é›†ã™ã‚‹

   ```bash
   crontab -e
   ```

   æ¯æ—¥ 04:00(UTC) ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã¨ã™ã‚‹\
   ã¤ã¾ã‚Š JST ã ã¨ 13:00 ã«å®Ÿè¡Œã•ã‚Œã‚‹

   ```bash
   0 4 * * * bash backup-psql-all.sh
   ```

---

### ãƒãƒ¼ãƒˆæ¤œç´¢ã®è¨±å¯

ï¼ˆãŠãã‚‰ãï¼‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ãƒãƒ¼ãƒˆæ¤œç´¢ã¯ç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ï¼ˆè² è·å¯¾ç­–ï¼Ÿï¼‰<br/>
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« > ç®¡ç† > ãƒ­ãƒ¼ãƒ« > ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ« å†…ã® **ãƒãƒ¼ãƒˆæ¤œç´¢ã®åˆ©ç”¨** ã‚’ **ã¯ã„** ã«å¤‰æ›´ã™ã‚‹

![changeSearchPermission](/others/build-misskey-in-vultr/changeSearchPermission.png)

## Bonus

è‡ªä½œã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã¸ã®ã‚³ãƒ”ãƒšç”¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±

[MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/) ç”¨

```txt
Public Domain.
Generated by [MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/).
[MEGAMOJI Licence](https://github.com/zk-phi/MEGAMOJI/blob/master/LICENSE.markdown).
```

[çµµæ–‡å­—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿](https://emoji-gen.ninja/)ç”¨

```txt
Public Domain.
Generated by [Emoji Generator](https://emoji-gen.ninja/)
```

[ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ XIV ãƒ•ã‚¡ãƒ³ã‚­ãƒƒãƒˆ](https://jp.finalfantasyxiv.com/lodestone/special/fankit/)ç”¨

```txt
(C) SQUARE ENIX CO., LTD. All Rights Reserved.
[ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼XIV è‘—ä½œç‰©åˆ©ç”¨è¨±è«¾æ¡ä»¶](http://support.jp.square-enix.com/rule.php?id=5381&la=0&tag=authc&_ebx=t87tbevhtu.1689168164.7smav6v)
```

## Ref

å‰å¤§ãªã‚‹é–‹ç™ºè€…ãŸã¡ã¨å…ˆé§†è€…ãŸã¡ã«æ·±ãæ„Ÿè¬

- [Misskey æ§‹ç¯‰ã®æ‰‹å¼•ã | Misskey Hub](https://misskey-hub.net/docs/install/manual.html)
- [Misskey install shell script v3.0.0 | Misskey Hub](https://misskey-hub.net/docs/install/bash.html)
- [Misskey ã®ã‚µãƒ¼ãƒã‚’è¨­ç½®ã™ã‚‹ï¼ˆv11 ç³»ï¼‰ - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)
- [Misskey ã®ãŠã²ã¨ã‚Šæ§˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å»ºã¦ã‚‹](https://zenn.dev/see2et/articles/building-an-one-person-instance-of-misskey#ssh%E6%8E%A5%E7%B6%9A%E3%81%A8%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89)
- [misskey ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« cloudflare r2 ã‚’åˆ©ç”¨ã™ã‚‹ - Qiita](https://qiita.com/hihumikan/items/1f692f3bd5516820e0ec)
- [Misskey ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§æœ€åˆã«è¨­å®šã™ã‚‹ã¹ãã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®šã¨ãã®ä»–è¨­å®šã®èª¬æ˜ | aqz/tamaina](https://hide.ac/articles/Y504SIabp)
- [misskey ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ cron ã§å®šæœŸçš„ã« Cloudflare R2 ã«ä¿å­˜ã™ã‚‹ | å°æŸå¼“æœˆ](https://note.com/yu_koduka/n/n0ba5807b16bf)
- [Amazon S3 ã¨ API ã®äº’æ›æ€§ãŒã‚ã‚‹ Cloudflare R2 ã‚’ AWS CLI ã‹ã‚‰ä½¿ã£ã¦ã¿ã‚‹ | DevelopersIO](https://dev.classmethod.jp/articles/using-cloudflare-r2-compatible-with-amazon-s3-api-from-aws-cli/)
- [Misskey ã§ Cloudflare R2 Storage ã‚’ä½¿ã†](https://nanasi-apps.xyz/r2-misskey)
- [Misskey ã§ Meilisearch ã‚’å°å…¥ã™ã‚‹ã‚„ã‚Šæ–¹](https://nanasi-apps.xyz/misskey-meilisearch)
- [Windows ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã§ UUID(GUID)ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³• - torutk ã®ãƒ–ãƒ­ã‚°](https://torutk.hatenablog.jp/entry/20160519/p1)
- [Using default API keys for authorization | Meilisearch Documentation](https://www.meilisearch.com/docs/learn/security/master_api_keys#using-default-api-keys-for-authorization)
- [Docker Compose ç‰ˆ Misskey ã«ãƒãƒ¼ãƒˆæ¤œç´¢ (Meilisearch) ã‚’å°å…¥ã™ã‚‹ - Qiita](https://qiita.com/arkw/items/81238fe96ec602a2e055)
- [meilisearch not working Â· Issue #11998 Â· misskey-dev/misskey](https://github.com/misskey-dev/misskey/issues/11998)
