import { Callout } from "nextra/components";

# å€‹äººç”¨ Misskey ã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹

ä¸€ç•ªå®‰ã„ã®ã‚’é ¼ã‚€

## Overview

å€‹äººã§éŠã¶ç”¨ã® [Misskey](https://github.com/misskey-dev/misskey) ã‚µãƒ¼ãƒï¼ˆv2023.10.0ï¼‰ã‚’ Vultr ã¨ Cloudflare ã§æ§‹ç¯‰ã™ã‚‹

## Architecture

- VPS

  [Vultr](https://www.vultr.com/) ã§ä¸€ç•ªå®‰ãã†ãª VPS ã‚’å€Ÿã‚ŠãŸ<br/>
  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ä»¥å¤–ã®è² è·ã¯ãã“ã¾ã§æ›ã‹ã‚‰ãªã„ã‚‰ã—ã„

  | Column      | Value               |
  | ----------- | ------------------- |
  | Server      | Vultr Cloud Compute |
  | Location    | Tokyo               |
  | OS          | Ubuntu 22.04        |
  | Application | NodeJS              |
  | Storage     | 25 GB NVMe          |
  | vCPU/s      | 1 vCPU              |
  | RAM         | 1024.00 MB          |
  | Additonal   | Enable IPv6         |

- Domain / DNS

  [Cloudflare Registrar](https://www.cloudflare.com/ja-jp/products/registrar/) ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ã€ç®¡ç†

- Object Storage

  [Cloudflare R2](https://www.cloudflare.com/ja-jp/developer-platform/r2/) ã‚’åˆ©ç”¨

## Flow

ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è³¼å…¥ã‹ã‚‰ Misskey ã®èµ·å‹•ã¾ã§ã®ä¸€é€£ã®æµã‚Œ

### Cloudflare ã§ Domain ã®å–å¾—

Cloudflare ã§å¥½ã¿ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è³¼å…¥ã™ã‚‹

[Cloudflare](https://www.cloudflare.com/) ã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå¾Œã€[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/)ãŒç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚‹<br/>
å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ² > ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ² ã‚’é–‹ã

![registerDomain1](/others/registerDomain1.png)

å¥½ã¿ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã§æ¤œç´¢ã™ã‚Œã°ã€åˆ©ç”¨å¯èƒ½ãªé¡ä¼¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒä¸€è¦§ã§è¡¨ç¤ºã•ã‚Œã‚‹<br/>
åˆ©ç”¨ãŒã§ããªã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã§ã‚ã‚Œã°ã€ãã®æ—¨ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§å†è€ƒã™ã‚‹

![registerDomain2](/others/registerDomain2.png)

åˆ©ç”¨ã—ãŸã„ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’é¸æŠã§ããŸã‚‰ã€è³¼å…¥ã‚’å®Œäº†ã™ã‚‹

---

### Vultr ã§ VPS ã‚’æ§‹ç¯‰ã™ã‚‹

Vultr ã‚µãƒ¼ãƒã®ç’°å¢ƒæ§‹ç¯‰ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã®ã“ã¨<br/>
ã“ã®è¨˜äº‹ã® **VPS ã‚µãƒ¼ãƒã‚’å€Ÿã‚Šã¦ã€ç’°å¢ƒã‚’æ•´å‚™ã™ã‚‹** ã®é …ã«å¾“ã£ã¦å®Ÿè¡Œã™ã‚Œã°ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å®Œäº†<br/>
ç­†è€…ã® VPS ã®æ§‹ç¯‰ã«ã¤ã„ã¦ã¯ã€ä¸Šè¿°ã® [Architecture](#architecture) ã«è¨˜è¼‰

[Misskey ã®ã‚µãƒ¼ãƒã‚’è¨­ç½®ã™ã‚‹ï¼ˆv11 ç³»ï¼‰ - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)

<Callout type="info" emoji="ï¸â„¹ï¸">
  DNS ã®è¨­å®šã«å¿…è¦ã¨ãªã‚‹ãŸã‚ã€ä½œæˆã—ãŸ VPS ã® `IP Address` ã¨ `IPv6 Address`
  ã‚’ç¢ºèªã—ã¦ãŠã
</Callout>

---

### Cloudflare ã§ DNS ã®è¨­å®š

Cloudflare ã®[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/)ã«ã¦ã€å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ² > ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç®¡ç† ã‚’é–‹ã

å…ˆç¨‹è³¼å…¥ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©²å½“ãƒ‰ãƒ¡ã‚¤ãƒ³ã® **ç®¡ç†** ã‚’é¸æŠ

![dnsSetting1](/others/dnsSetting1.png)

ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã® **DNS ã®è¨­å®šã‚’æ›´æ–°ã™ã‚‹** ã‚’é¸æŠ

DNS ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€**ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ ** ã‚’é¸æŠã—ã€ä»¥ä¸‹ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹<br/>

<Callout type="info" emoji="ï¸â„¹ï¸">
  åå‰ã«ã¯åˆ©ç”¨ã—ãŸã„ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹<br />
  ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ`example.com`ã ã£ãŸå ´åˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’`mk`ã¨ã™ã‚‹ã¨ã€`mk.example.com`ãŒã‚µãƒ¼ãƒãƒ¼ã®URLã¨ãªã‚‹<br />
  ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä»˜ä¸ã—ãŸããªã„å ´åˆã¯ã€`@`ã‚’å…¥åŠ›ã™ã‚‹
</Callout>

| ã‚¿ã‚¤ãƒ— | åå‰           | ã‚¢ãƒ‰ãƒ¬ã‚¹                |
| ------ | -------------- | ----------------------- |
| A      | (ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³) | (Vultr ã® IP Address)   |
| AAAA   | (ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³) | (Vultr ã® IPv6 Address) |

![dnsSetting2](/others/dnsSetting2.png)

---

### Vultr ã‚µãƒ¼ãƒ ã¸ã® SSH ã®è¨­å®š

WIP

[Misskey ã®ã‚µãƒ¼ãƒã‚’è¨­ç½®ã™ã‚‹ï¼ˆv11 ç³»ï¼‰ - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)

---

### [Misskey install shell script v3.0.0](https://misskey-hub.net/docs/install/bash.html) ã®å®Ÿè¡Œ

æ‰‹å‹•ã§ã‚„ã£ã¦ã¿ãŸã‚Šã—ã‚ˆã†ã¨ã‚‚ã—ãŸã‘ã©ã€å¤šåˆ†ã“ã‚ŒãŒä¸€ç•ªæ¥½ã§æ—©ã„ã¨æ€ã„ã¾ã™

æ‰‹é †ã«æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚Šã«é€²ã‚ã‚‹<br/>
æ–°ã—ã„ã‚‚ã®å¥½ããªã®ã§ develop branch ã‚’é¸ã‚“ã ãŒã€æ™®é€šã¯ master branch ã«ã™ã‚‹ã®ãŒç„¡é›£ã ã¨æ€ã†

é€”ä¸­ã§ Cloudflare ã® API Key ã‚’è¦æ±‚ã•ã‚Œã‚‹ãŒã€ãã¡ã‚“ã¨èª˜å°ã—ã¦ãã‚Œã‚‹ã®ã§ãã‚Œã«å¾“ãˆã°å•é¡Œãªã„<br/>
æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Š [Cloudflare ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/profile/api-tokens) ã‚’é–‹ã„ã¦ `Global API Key` ã‚’è¡¨ç¤ºã€ã‚³ãƒ”ãƒšã™ã‚Œã°ã‚ˆã„

![checkCloudflareApiKey](/others/checkCloudflareApiKey.png)

<Callout type="error" emoji="ï¸ğŸš«">
  é€”ä¸­ã§å‡¦ç†ã«å¤±æ•—ã—ã€å†åº¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã«æ³¨æ„ã™ã‚‹
  > Redisã‚„Postgresã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã€ã€Œ`install locally`ã€ã¯`No`ã«ã—ã¦ãã ã•ã„ã€‚
</Callout>

ä»¥ä¸‹ã€ç­†è€…ã®é¸æŠä¸€è¦§ã€€å¤§ä½“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

| Install script option                                         | Value                                                  |
| ------------------------------------------------------------- | ------------------------------------------------------ |
| Do you use systemd to run Misskey?                            | Y (Use `Systemd`)                                      |
| Repository url where you want to install                      | `https://github.com/misskey-dev/misskey.git` (default) |
| The name of a new directory to clone                          | misskey (default)                                      |
| Branch or Tag                                                 | **develop**                                            |
| Enter the name of user with which you want to execute Misskey | misskey (default)                                      |
| Enter host where you want to install Misskey                  | (Own Host Name, e.g. `example.com`)                    |
| Do you want to setup nginx?                                   | Y                                                      |
| Misskey port                                                  | 3000 (default)                                         |
| Do you want it to open ports, to setup ufw or iptables?       | u (To setup ufw)                                       |
| SSH port                                                      | 22 (default)                                           |
| Do you want it to setup certbot to connect with https?        | Y                                                      |
| Do you use Cloudflare?                                        | Y                                                      |
| Enter Email address you registered to Cloudflare              | (Own Email Address)                                    |
| Cloudflare API Key                                            | (Own Cloudflare API Key)                               |
| Tell me which port Misskey will watch                         | 3000 (default)                                         |
| Do you want to install postgres locally?                      | Y                                                      |
| Database user name                                            | misskey (default)                                      |
| Database user password                                        | (Any password)                                         |
| Database name                                                 | mk1 (default)                                          |
| Do you want to install redis locally?                         | Y                                                      |
| Redis password                                                | (Any password)                                         |

---

### Cloudflare R2 ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š

WIP

[misskey ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« cloudflare r2 ã‚’åˆ©ç”¨ã™ã‚‹ - Qiita](https://qiita.com/hihumikan/items/1f692f3bd5516820e0ec)

---

### Cloudflare R2 ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

WIP

[misskey ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ cron ã§å®šæœŸçš„ã« Cloudflare R2 ã«ä¿å­˜ã™ã‚‹ | å°æŸå¼“æœˆ](https://note.com/yu_koduka/n/n0ba5807b16bf)

---

### ãƒãƒ¼ãƒˆæ¤œç´¢ã®è¨±å¯

ï¼ˆãŠãã‚‰ãï¼‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ãƒãƒ¼ãƒˆæ¤œç´¢ã¯ç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ï¼ˆè² è·å¯¾ç­–ï¼Ÿï¼‰<br/>
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« > ç®¡ç† > ãƒ­ãƒ¼ãƒ« > ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ« å†…ã® **ãƒãƒ¼ãƒˆæ¤œç´¢ã®åˆ©ç”¨** ã‚’ **ã¯ã„** ã«å¤‰æ›´ã™ã‚‹

![changeSearchPermission](/others/changeSearchPermission.png)

---

### (Meilisearch ã®è¨­å®š)

WIP

[meilisearch not working Â· Issue #11998 Â· misskey-dev/misskey](https://github.com/misskey-dev/misskey/issues/11998)

## Bonus

ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­— ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±

[MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/) ç”¨

```txt
Public Domain.
Generated by [MEGAMOJI](https://zk-phi.github.io/MEGAMOJI/).
[MEGAMOJI Licence](https://github.com/zk-phi/MEGAMOJI/blob/master/LICENSE.markdown).
```

[çµµæ–‡å­—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿](https://emoji-gen.ninja/)ç”¨

```txt
Public Domain.
Generated by [Emoji Generator](https://emoji-gen.ninja/)
```

[ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ XIV ãƒ•ã‚¡ãƒ³ã‚­ãƒƒãƒˆ](https://jp.finalfantasyxiv.com/lodestone/special/fankit/)ç”¨

```txt
(C) SQUARE ENIX CO., LTD. All Rights Reserved.
[ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼XIV è‘—ä½œç‰©åˆ©ç”¨è¨±è«¾æ¡ä»¶](http://support.jp.square-enix.com/rule.php?id=5381&la=0&tag=authc&_ebx=t87tbevhtu.1689168164.7smav6v)
```

## Ref

å‰å¤§ãªã‚‹é–‹ç™ºè€…ãŸã¡ã¨å…ˆé§†è€…ãŸã¡ã«æ·±ãæ„Ÿè¬

- [Misskey æ§‹ç¯‰ã®æ‰‹å¼•ã | Misskey Hub](https://misskey-hub.net/docs/install/manual.html)
- [Misskey install shell script v3.0.0 | Misskey Hub](https://misskey-hub.net/docs/install/bash.html)
- [Misskey ã®ã‚µãƒ¼ãƒã‚’è¨­ç½®ã™ã‚‹ï¼ˆv11 ç³»ï¼‰ - noellabo's tech blog](https://blog.noellabo.jp/entry/2019/08/14/8i3RHuZ1wJNDinIn)
- [Misskey ã®ãŠã²ã¨ã‚Šæ§˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å»ºã¦ã‚‹](https://zenn.dev/see2et/articles/building-an-one-person-instance-of-misskey#ssh%E6%8E%A5%E7%B6%9A%E3%81%A8%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89)
- [misskey ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« cloudflare r2 ã‚’åˆ©ç”¨ã™ã‚‹ - Qiita](https://qiita.com/hihumikan/items/1f692f3bd5516820e0ec)
- [Misskey ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§æœ€åˆã«è¨­å®šã™ã‚‹ã¹ãã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®šã¨ãã®ä»–è¨­å®šã®èª¬æ˜ | aqz/tamaina](https://hide.ac/articles/Y504SIabp)
- [misskey ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ cron ã§å®šæœŸçš„ã« Cloudflare R2 ã«ä¿å­˜ã™ã‚‹ | å°æŸå¼“æœˆ](https://note.com/yu_koduka/n/n0ba5807b16bf)
- [Amazon S3 ã¨ API ã®äº’æ›æ€§ãŒã‚ã‚‹ Cloudflare R2 ã‚’ AWS CLI ã‹ã‚‰ä½¿ã£ã¦ã¿ã‚‹ | DevelopersIO](https://dev.classmethod.jp/articles/using-cloudflare-r2-compatible-with-amazon-s3-api-from-aws-cli/)
- [Misskey ã§ Cloudflare R2 Storage ã‚’ä½¿ã†](https://nanasi-apps.xyz/r2-misskey)
- [Misskey ã§ Meilisearch ã‚’å°å…¥ã™ã‚‹ã‚„ã‚Šæ–¹](https://nanasi-apps.xyz/misskey-meilisearch)
- [Windows ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã§ UUID(GUID)ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³• - torutk ã®ãƒ–ãƒ­ã‚°](https://torutk.hatenablog.jp/entry/20160519/p1)
- [Meilisearch Documentation](https://www.meilisearch.com/docs/learn/security/master_api_keys#using-default-api-keys-for-authorization)
- [Docker Compose ç‰ˆ Misskey ã«ãƒãƒ¼ãƒˆæ¤œç´¢ (Meilisearch) ã‚’å°å…¥ã™ã‚‹ - Qiita](https://qiita.com/arkw/items/81238fe96ec602a2e055)
